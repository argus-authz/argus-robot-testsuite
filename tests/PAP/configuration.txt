*** Settings ***
Library    OperatingSystem
Resource   lib/utils.txt
Resource   variables.txt

Suite Setup     Make backup of the configuration
Suite Teardown  Restore configurations

Test Setup     Stop PAP service
Test Teardown  Restore PAP configuration

*** Test Cases ***

Missing configuration file
  ${file}=  Join Path  ${T_PAP_CONF}  ${T_PAP_CONF_INI}
  Remove File  ${file}
  List Directory  ${T_PAP_CONF}
  Start PAP
  Execute and Check Failure  ${T_PAP_CTRL} status | grep -q 'PAP running'
  
Missing Argus file
  ${file}=  Join Path  ${T_PAP_CONF}  ${T_PAP_AUTH_INI}
  Remove File  ${file}
  List Directory  ${T_PAP_CONF}
  Start PAP
  Execute and Check Failure  ${T_PAP_CTRL} status | grep -q 'PAP running'
  [Teardown]  Restore PAP configuration
  
Required pool_interval
  ${file}=  Join Path  ${T_PAP_CONF}  ${T_PAP_CONF_INI}
  Comment parameter  ${file}  poll_interval
  Start PAP
  Execute and Check Failure  ${T_PAP_CTRL} status | grep -q 'PAP running'
  
#Syntax error: missing '='
#  Stop PAP service
#  ${file}=  Join Path  ${T_PAP_CONF}  ${T_PAP_CONF_INI}
#  Replace string  ${file}  entity_id\ =  entity_id\ \ 
#  Start PAP service
#  Execute and Check Failure  ${T_PAP_CTRL} status | grep -q 'PAP running'
#  [Teardown]  Restore PAP configuration
  
Syntax error: missing ']'
  ${file}=  Join Path  ${T_PAP_CONF}  ${T_PAP_CONF_INI}
  Replace string  ${file}  \\[paps:properties\\]  \\[paps:properties
  Start PAP
  Execute and Check Failure  ${T_PAP_CTRL} status | grep -q 'PAP running'
  
Argus syntax error: missing ']'
  ${file}=  Join Path  ${T_PAP_CONF}  ${T_PAP_AUTH_INI}
  Replace string  ${file}  \\[dn\\]  \\[dn
  Start PAP
  Execute and Check Failure  ${T_PAP_CTRL} status | grep -q 'PAP running'
  
Argus syntax error: missing ':'
  ${file}=  Join Path  ${T_PAP_CONF}  ${T_PAP_AUTH_INI}
  ${content}=  Get content test 6
  Create File  ${file}  ${content}
  Start PAP
  Execute and Check Failure  ${T_PAP_CTRL} status | grep -q 'PAP running'

Argus syntax error: missing 'permission'
  ${file}=  Join Path  ${T_PAP_CONF}  ${T_PAP_AUTH_INI}
  ${content}=  Get content test 7
  Create File  ${file}  ${content}
  Start PAP
  Execute and Check Failure  ${T_PAP_CTRL} status | grep -q 'PAP running'


*** Keywords ***
Get content test 6
  ${text}=  catenate  SEPARATOR=
  ...  [dn]\n
  ...  "/C=CH/O=CERN/OU=GD/CN=Test user 300"  ALL\n
  ...  "/DC=ch/DC=cern/OU=computers/CN=vtb-generic-54.cern.ch" : POLICY_READ_LOCAL|POLICY_READ_REMOTE\n
  ...  \n
  ...  [fqan]\n
  [Return]  ${text}
  
Get content test 7
  ${text}=  catenate  SEPARATOR=
  ...  [dn]\n
  ...  "/C=CH/O=CERN/OU=GD/CN=Test user 300" \n
  ...  "/DC=ch/DC=cern/OU=computers/CN=vtb-generic-54.cern.ch" : POLICY_READ_LOCAL|POLICY_READ_REMOTE\n
  ...  \n
  ...  [fqan]\n
  [Return]  ${text}
  
Start PAP
  Run Process  systemctl  start  argus-pap
  Sleep  15s
  