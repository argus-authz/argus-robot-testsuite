*** Settings ***
Library    OperatingSystem
Resource   lib/utils.txt
Resource   variables.txt

Suite Setup     Make backup of the configuration
Suite Teardown  Restore configurations


*** Test Cases ***
User mapping case 1 (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=yes
  ...  pref_dn_for_login=true  pref_dn_for_primary_grp=true  no_primary_grp_is_error=true
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${TEST_DN_UID_GROUP}
  Check if secondary group match  ${output}  ${TEST_DN_UID_GROUP}
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${TEST_DN_UID_GROUP}
  Check if secondary group match  ${output}  ${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration

User mapping case 2 (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=yes
  ...  pref_dn_for_login=false  pref_dn_for_primary_grp=true  no_primary_grp_is_error=true
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${TEST_DN_UID_GROUP}
  Check if secondary group match  ${output}  ${TEST_DN_UID_GROUP}
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${VO}\\d+
  Check if group match  ${output}  ${TEST_DN_UID_GROUP}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 3 (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=yes
  ...  pref_dn_for_login=true  pref_dn_for_primary_grp=false  no_primary_grp_is_error=true
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${TEST_DN_UID_GROUP}
  Check if secondary group match  ${output}  ${TEST_DN_UID_GROUP}
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 4 (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=yes
  ...  pref_dn_for_login=false  pref_dn_for_primary_grp=false  no_primary_grp_is_error=true
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${TEST_DN_UID_GROUP}
  Check if secondary group match  ${output}  ${TEST_DN_UID_GROUP}
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${VO}\\d+
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 5 (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=no
  ...  pref_dn_for_login=true  pref_dn_for_primary_grp=true  no_primary_grp_is_error=true
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${RULE_INDETERMINATE}
  Should Contain  ${output}  Failed to map subject
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 5a (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=no
  ...  pref_dn_for_login=true  pref_dn_for_primary_grp=true  no_primary_grp_is_error=false
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 6 (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=no
  ...  pref_dn_for_login=false  pref_dn_for_primary_grp=true  no_primary_grp_is_error=true
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${RULE_INDETERMINATE}
  Should Contain  ${output}  Failed to map subject
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${VO}\\d+
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 6a (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=no
  ...  pref_dn_for_login=false  pref_dn_for_primary_grp=true  no_primary_grp_is_error=false
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${VO}\\d+
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 7 (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=no
  ...  pref_dn_for_login=true  pref_dn_for_primary_grp=false  no_primary_grp_is_error=true
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${RULE_INDETERMINATE}
  Should Contain  ${output}  Failed to map subject
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 7a (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=no
  ...  pref_dn_for_login=true  pref_dn_for_primary_grp=false  no_primary_grp_is_error=false
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 8 (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=no
  ...  pref_dn_for_login=false  pref_dn_for_primary_grp=false  no_primary_grp_is_error=true
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${RULE_INDETERMINATE}
  Should Contain  ${output}  Failed to map subject
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${VO}\\d+
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
User mapping case 8a (bug 69197)
  &{dict}=  Create Dictionary
  ...  vo_map=yes  dn_map=yes
  ...  grp_vo_map=yes  grp_vo_sec_map=no  grp_dn_map=no
  ...  pref_dn_for_login=false  pref_dn_for_primary_grp=false  no_primary_grp_is_error=false
  Prepare PEP environment  &{dict}
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${USERCERT}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${TEST_DN_UID}
  ${user_proxy}=  Get user proxy path
  ${output}=  Perform PEP request  ${USERKEY}  ${USERCERT}  ${user_proxy}  ${TEST_RESOURCE}  ${TEST_ACTION}
  Check if rule match  ${output}  ${TEST_RULE}
  Check if username match  ${output}  ${VO}\\d+
  Check if group match  ${output}  ${VO}
  Check if secondary group match  ${output}  ${VO}|${TEST_DN_UID_GROUP}
  [Teardown]  Restore PEP configuration
  
  